#!/usr/bin/env bash
# shellcheck disable=SC2153
set -eu

# shellcheck source=./env.globals
source bin/env.globals

mkdir -p configs

if [[ ! -f configs/.private || ! -f configs/projects ]]; then
  echo -e "${RED}Error.${NC} Missing environment files."
  echo "Please run bin/init"
  exit 1
fi

# shellcheck source=../configs/.private
source configs/.private
# shellcheck source=../configs/projects
source configs/projects

STATIC_FILENAME="configs/traefik.toml"
PROJECTS_FILENAME="configs/projects.toml"
PROJECTS="$(echo "$PROJECTS" | tr ' ' '\n' | sort -u | xargs)"

# shellcheck disable=2206
projects=( $PROJECTS )

cat > "$STATIC_FILENAME" << EOF
[providers]
  [providers.file]
    filename = "$PROJECTS_FILENAME"

[api]
  dashboard = true

[entryPoints]
  [entryPoints.http]
    address = ":80"
    [entryPoints.http.http]
      [entryPoints.http.http.redirections]
        [entryPoints.http.http.redirections.entrypoint]
          to = "https"
          scheme = "https"
  [entryPoints.https]
    address = ":443"
  [entryPoints.dashboard]
    address = ":8088"

[certificatesResolvers.default.acme]
  email = "$EMAIL"
  storage = "acme.json"
  [certificatesResolvers.default.acme.dnsChallenge]
    provider = "$PROVIDER"
    delayBeforeCheck = 0

EOF

cat > "$PROJECTS_FILENAME" << EOF
[http]
  [http.middlewares.sslheader.headers.customrequestheaders]
    X-Forwarded-Proto = "https"
  [http.routers]
    [http.routers.dashboard]
      rule = "Host(\`traefik.$LOCAL_DOMAIN\`)"
      service = "api@internal"
    [[http.routers.dashboard.tls.domains]]
      sans = ["*.$LOCAL_DOMAIN"]

EOF

for project in "${projects[@]}"; do
  SLUG=${project%%:*}
  cat >> "$PROJECTS_FILENAME" << EOF
    [http.routers.$SLUG]
      rule = "Host(\`$SLUG.$LOCAL_DOMAIN\`)"
      service = "$SLUG"
      entryPoints = ["https"]
    [http.routers.$SLUG.tls]
      certResolver = "default"
    [[http.routers.$SLUG.tls.domains]]
      sans = ["*.$LOCAL_DOMAIN"]

EOF
done

echo "  [http.services]" >> "$PROJECTS_FILENAME"

for project in "${projects[@]}"; do
  SLUG=${project%%:*}
  PORT=${project##*:}
  cat >> "$PROJECTS_FILENAME" << EOF
    [http.services.$SLUG.loadbalancer]
      [[http.services.$SLUG.loadbalancer.servers]]
        url = "http://127.0.0.1:$PORT"

EOF
done
