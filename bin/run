#!/usr/bin/env bash
set -eu

# shellcheck source=./env.globals
source bin/env.globals

if [[ ! -d configs || ! -f configs/.private || ! -f configs/projects ]]; then
  echo -e "${RED}Error.${NC} Missing environment files."
  echo "Please run bin/init"
  exit 1
fi

# shellcheck source=../configs/.private
source configs/.private
# shellcheck source=../configs/projects
source configs/projects

generate_log_configs() {
  type="${1:verbose}"
  if [[ "$type" == "verybose" ]]; then
    cat > configs/logging.toml << EOF
[accessLog]
  bufferingSize = 100
EOF
  fi

  cat > configs/logging.toml << EOF
[log]
  level="DEBUG"
EOF
}

USAGE="
${BROWN}Usage${NC}: $0 [FLAGS]

${BROWN}Flags${NC}:
  [-v|--verbose]  More logging
  [-vv|--verybose] Moar logging
"

# Remove old logging config
rm -f configs/logging.toml

# Handle args
for arg in "$@"; do
  if [ "$arg" = "help" ] || [ "$arg" = "--help" ] || [ "$arg" = "-h" ]; then
    echo -e "$USAGE"
    exit 0
  elif [ "$arg" = "--verbose" ] || [ "$arg" = "-v" ]; then
    # shellcheck disable=SC2119
    generate_log_configs
    echo -e "${YELLOW}Running in verbose mode${NC}"
  elif [ "$arg" = "--verybose" ] || [ "$arg" = "-vv" ]; then
    # shellcheck disable=SC2119
    generate_log_configs verybose
  else
    echo "Unknown argument '$arg'"
    exit 0
  fi
done

case "$PROVIDER" in
  digitalocean)
    DO_AUTH_TOKEN="$DO_AUTH_TOKEN" bin/traefik
    ;;

  *)
    echo -e "${RED}Error!${NC} Unknown provider."
    exit 1
esac
