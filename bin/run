#!/usr/bin/env bash
set -eu

# shellcheck source=./env.globals
source bin/env.globals

# shellcheck source=../.env
source .env

USAGE="
${BROWN}Usage${NC}: $0 [FLAGS]

${BROWN}Flags${NC}:
  [-v|--verbose]  More logging
  [-vv|--verybose] Moar logging
"

FLAGS=""
FLAGS_V="--accesslog=true --accesslog.bufferingsize=100 --log=true --log.level="
FLAGS_VV="--providers.file.debugloggeneratedtemplate=true"

# Handle args
for arg in "$@"; do
  if [ "$arg" = "help" ] || [ "$arg" = "--help" ] || [ "$arg" = "-h" ]; then
    echo -e "$USAGE"
    exit 0
  elif [ "$arg" = "--verbose" ] || [ "$arg" = "-v" ]; then
    FLAGS="$FLAGS ${FLAGS_V}ERROR"
    echo -e "${YELLOW}Running in verbose mode${NC}"
  elif [ "$arg" = "--verybose" ] || [ "$arg" = "-vv" ]; then
    echo -e "${YELLOW}Running in verybose mode${NC}"
    FLAGS="$FLAGS ${FLAGS_V}DEBUG $FLAGS_VV"
    echo "$FLAGS"
  else
    echo "Unknown argument '$arg'"
    exit 0
  fi
done

if [[ -f acme.json ]]; then
  # shellcheck disable=SC2086
  ./traefik $FLAGS
else
  # shellcheck disable=SC2086
  DO_AUTH_TOKEN="$DO_AUTH_TOKEN" ./traefik $FLAGS
fi
