#!/usr/bin/env bash
set -eu

# shellcheck source=./env.globals
source bin/env.globals

if [[ ! -f .private || ! -f projects ]]; then
  echo -e "${RED}Error.${NC} Missing environment files."
  echo "Please run bin/init"
  exit 1
fi

# shellcheck source=../.private
source .private
# shellcheck source=../projects
source projects

USAGE="
${BROWN}Usage${NC}: $0 [FLAGS]

${BROWN}Flags${NC}:
  [-v|--verbose]  More logging
  [-vv|--verybose] Moar logging
"

FLAGS=""
FLAGS_V="--accesslog=true --accesslog.bufferingsize=100 --log=true --log.level="
FLAGS_VV="--providers.file.debugloggeneratedtemplate=true"

# Handle args
for arg in "$@"; do
  if [ "$arg" = "help" ] || [ "$arg" = "--help" ] || [ "$arg" = "-h" ]; then
    echo -e "$USAGE"
    exit 0
  elif [ "$arg" = "--verbose" ] || [ "$arg" = "-v" ]; then
    FLAGS="$FLAGS ${FLAGS_V}ERROR"
    echo -e "${YELLOW}Running in verbose mode${NC}"
  elif [ "$arg" = "--verybose" ] || [ "$arg" = "-vv" ]; then
    echo -e "${YELLOW}Running in verybose mode${NC}"
    FLAGS="$FLAGS ${FLAGS_V}DEBUG $FLAGS_VV"
    echo "$FLAGS"
  else
    echo "Unknown argument '$arg'"
    exit 0
  fi
done

# Run Traefik
case "$PROVIDER" in
  digitalocean)
    # shellcheck disable=SC2086
    DO_AUTH_TOKEN="$DO_AUTH_TOKEN" bin/traefik $FLAGS
    ;;
  #my-provider)
  #  PROVIDER_VAR_1="$PROVIDER_VAR_1" \
  #  PROVIDER_VAR_2="$PROVIDER_VAR_2" \
  #  ANOTHER_PROVIDER_VAR="$ANOTHER_PROVIDER_VAR" ./traefik $FLAGS
  #  ;;
  *)
    echo -e "${RED}Error!${NC} Unknown provider."
    exit 1
esac
